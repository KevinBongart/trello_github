#!/usr/bin/env ruby
require 'CGI'
require 'git'
require 'gli'
require 'trello_github'

include GLI::App

program_desc 'Describe your application here'

version TrelloGithub::VERSION

desc 'Describe create here'
arg_name 'Describe arguments to create here'
command :branch do |c|
  c.action do |global_options, options, args|
    trello_url = args.first

    branch = trello_url.gsub(/.+\/(.+)/,'\1')
    branch.tr!("-", "_")
    branch.downcase!

    exec "grb create #{branch}"
  end
end

command :pr do |c|
  c.action do |global_options, options, args|
    local_repo = Git.init
    remote_repo = local_repo.remotes.first.url.gsub(/.+:(.+)\.git/, '\1')

    branch = Git.init.lib.branch_current

    if args.any?
      description = args.first
      description = CGI::escape("[Trello](#{description})")
    end

    url = "https://github.com/#{remote_repo}/compare/#{branch}?expand=1"
    url += "&body=#{description}" if description

    exec "open #{url}"
  end
end

exit run(ARGV)
